<!DOCTYPE html>
<html>
<head>
<title>UHK layout</title>
<meta charset="utf-8">
</head>
<body>
<div id="layout"></div>
<script src="../components/jquery/dist/jquery.min.js"></script>
<script src="../components/svg.js/dist/svg.min.js"></script>
<script src="../svg.parser.min.js"></script>
<script src="../components/svg.import.js/svg.import.min.js"></script>
<script>

var root, layout;
var fontSize = 19;
var normalKeycapHeight;
var bottomKeycapHeight;
var keycapHeightInMm = 18;
var singleLineHeight;
var doubleLineHeight;
var labelGap;
var bottomLabelGap;

var keycapTopHeight = 13.8;
var keycapTopWidth = 12.5;

keycapOffsets = [
    -1.252,
    -1.363,
    -1.448,
    -1.539,
    -1.539,
    0,
];

$.get('layout.svg', function(data) {
    var serializer = new XMLSerializer();
    var rawSvg = serializer.serializeToString(data);
    root = SVG('layout').svg(rawSvg);
    layout = root.roots()[0];

    var text = layout.text('A').font({family:'Helvetica', size:fontSize, anchor:'middle'}).addTo(SVG.get('left-parts'));
    singleLineHeight = text.bbox().height;
    text.remove();

    var text = layout.text('A\nA').font({family:'Helvetica', size:fontSize, anchor:'middle'}).addTo(SVG.get('left-parts'));
    doubleLineHeight = text.bbox().height;
    text.remove();

    normalKeycapHeight = SVG.get('a1').height();
    bottomKeycapHeight = SVG.get('f1').height();

    var layer = getParameterByName('layer');
    if (!layer) {
        layer = 'base';
    }

    $.each(layers[layer], function(i, n) {
        labelKeycap(i, n);
    });

    var onlyKeycaps = getParameterByName('onlyKeycaps') == 'true';
    if (onlyKeycaps) {
        showOnlyKeycapTops();
    }
});

function getParameterByName(name) {
    // Borrowed from http://stackoverflow.com/a/901144/1449117
    name = name.replace(/[\[]/, "\\[").replace(/[\]]/, "\\]");
    var regex = new RegExp("[\\?&]" + name + "=([^&#]*)"),
        results = regex.exec(location.search);
    return results == null ? "" : decodeURIComponent(results[1].replace(/\+/g, " "));
}

function labelKeycap(keycapId, label)
{
    var isKeyBottom = keycapId.charAt(0) == 'f';
    var keycapHeight = isKeyBottom ? bottomKeycapHeight : normalKeycapHeight;

    var hasLabelOneLine = label.indexOf('\n') === -1;
    var lineHeight = hasLabelOneLine ? singleLineHeight : doubleLineHeight;

    var labelGap = (keycapHeight - lineHeight) / 2;

    if (label.charAt(0) == '*') {
        label = label.substr(1);
        SVG.get(keycapId).fill('#800');
    }

    var key = root.get(keycapId);
    var text = layout.
        text(label).
        font({family:'Helvetica', size:fontSize, anchor:'middle'}).
        fill('#fff').
        move(key.x()+key.width()/2, key.y()+labelGap).
        addTo(key.parent);
}

function showOnlyKeycapTops()
{
    $.each(layers['base'], function(keyId, n) {
        if (keyId.charAt(0) != 'f') {
            var key = root.get(keyId);
            var keyWidthDifference = mmToSvgUnit(keycapHeightInMm-keycapTopWidth);
            var keyHeightDifference = mmToSvgUnit(keycapHeightInMm-keycapTopHeight);
            var rowNumber = keyIdToRowNumber(keyId);
            var keyOffset = keycapOffsets[rowNumber];

            key.width(key.width() - keyWidthDifference);
            key.height(key.height() - keyHeightDifference);
            key.x(key.x() + keyWidthDifference/2);
            key.y(key.y() + keyHeightDifference/2 + keyOffset);
        }
    });
    SVG.get('left-case').hide();
    SVG.get('right-case').hide();
}

function mmToSvgUnit(mm)
{
    return (normalKeycapHeight / keycapHeightInMm) * mm;
}

function keyIdToRowNumber(keyId)
{
    return keyId.charCodeAt(0) - 'a'.charCodeAt(0);
}

function isBottommostKey(keyId)
{
    return keyIdToRowNumber(keyId) == 5;
}

var layers = {
    'base': {
        'a1' : '`',
        'a2' : '1',
        'a3' : '2',
        'a4' : '3',
        'a5' : '4',
        'a6' : '5',
        'a7' : '6',
        'a8' : '7',
        'a9' : '8',
        'a10': '9',
        'a11': '0',
        'a12': '-',
        'a13': '=',
        'a14': '←',
        'b1' : 'Tab',
        'b2' : 'Q',
        'b3' : 'W',
        'b4' : 'E',
        'b5' : 'R',
        'b6' : 'T',
        'b7' : 'Y',
        'b8' : 'U',
        'b9' : 'I',
        'b10': 'O',
        'b11': 'P',
        'b12': '[',
        'b13': ']',
        'b14': '\\',
        'c1' : 'Mouse',
        'c2' : 'A',
        'c3' : 'S',
        'c4' : 'D',
        'c5' : 'F',
        'c6' : 'G',
        'c7' : 'H',
        'c8' : 'J',
        'c9' : 'K',
        'c10': 'L',
        'c11': ';',
        'c12': '\'',
        'c13': 'Enter',
        'd1' : 'Shift',
        'd2' : 'Z',
        'd3' : 'X',
        'd4' : 'C',
        'd5' : 'V',
        'd6' : 'B',
        'd7' : 'N',
        'd8' : 'M',
        'd9' : ',',
        'd10': '.',
        'd11': '/',
        'd12': 'Shift',
        'e1' : 'Super',
        'e2' : 'Ctrl',
        'e3' : 'Alt',
        'e4' : 'Fn',
        'e5' : 'Mod',
        'e6' : 'Space',
        'e7' : 'Fn',
        'e8' : 'Alt',
        'e9' : 'Ctrl',
        'e10': 'Super',
        'f1' : 'Space',
        'f2' : 'Mod',
    },
    'mod': {
        'a1' : 'Esc',
        'a2' : 'F1',
        'a3' : 'F2',
        'a4' : 'F3',
        'a5' : 'F4',
        'a6' : 'F5',
        'a7' : 'F6',
        'a8' : 'F7',
        'a9' : 'F8',
        'a10': 'F9',
        'a11': 'F10',
        'a12': 'F11',
        'a13': 'F12',
        'b2' : 'close\ntab',
        'b3' : 'prev\ntab',
        'b4' : 'new\ntab',
        'b5' : 'next\ntab',
        'b7' : 'PgUp',
        'b8' : 'Home',
        'b9' : '↑',
        'b10': 'End',
        'b11': 'Delete',
        'c2' : 'Caps\nLock',
        'c4' : 'Alt\nTab',
        'c7' : 'PgDn',
        'c8' : '←',
        'c9' : '↓',
        'c10': '→',
        'c11': 'Insert',
        'e5' : '*Mod',
        'f2' : '*Mod',
    },
    'fn': {
        'b8' : 'Play',
        'b9' : 'Vol\nUp',
        'b10': 'Pause',
        'c8' : 'Prev\nTrack',
        'c9' : 'Vol\nDown',
        'c10': 'Next\nTrack',
        'd9' : 'Mute',
        'e4' : '*Fn',
        'e7' : '*Fn',
    },
    'mouse': {
        'c1' : '*Mouse',
        'c3' : 'right\nclick',
        'c4' : 'middle\nclick',
        'c5' : 'left\nclick',
        'b9' : '↑',
        'c8' : '←',
        'c9' : '↓',
        'c10': '→',
    }
}

</script>
</body>
